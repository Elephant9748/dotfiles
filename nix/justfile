set quiet
bangbash := '#!/usr/bin/env bash'

# pkgs ...
tools:
        nix-env -iA nixos.git nixos.neovim nixos.fish nixos.just
# clean nix-collect-garbage -d
clean:
        nix-collect-garbage -d
# show available configurations
show:
        nix flake show  --experimental-features 'nix-command flakes'
# generate nixos config on this machine
gen:
        nixos-generate-config --root /mnt
# install nixos with flake
install $machine:
        {{bangbash}}
        nixos-install --flake .#{{machine}} --verbose
# rebuild nixos with flake
build $machine:
        {{bangbash}}
        sudo nixos-rebuild switch --flake .#{{machine}}
# flake update
flake-up:
        nix flake update

# change user for x machine flake.nix
flake-user $machine $user:
        {{bangbash}}
        sed -i '/{{machine}} = {/,/};/ s/user =.*/user = "{{user}}";/' flake.nix
# change host for x machine flake.nix
flake-host $machine $host:
        {{bangbash}}
        sed -i '/{{machine}} = {/,/};/ s/host =.*/host = "{{host}}";/' flake.nix
# change machine base = minimal, full = with gui
flake-full $user:
        {{bangbash}}
        sed -i 's/_base.nix/_full.nix/' flake.nix
        sed -i 's/_home_base.nix/_home_full.nix/' flake.nix
        printf "\033[0;34m> Done look flake.nix\n\033[0m"
# change machine base = minimal, full = with gui
flake-base $user:
        {{bangbash}}
        sed -i 's/_full.nix/_base.nix/' flake.nix
        sed -i 's/_home_full.nix/_home_base.nix/' flake.nix
        printf "\033[0;34m> Done look flake.nix\n\033[0m"

# rsync fish config to host manual
to-host-fish $user:
        #!/usr/bin/env bash
        if [[ ! -d "$HOME/.config/base16-shell" ]]; then
                git clone https://github.com/chriskempson/base16-shell.git ~/.config/base16-shell
        fi
        if command -v rsync &> /dev/null; then
                if [ "{{user}}" == "root" ]; then
                        sudo rsync -azP ../configs/.config/fish /root/.config/
                else
                        rsync -azP ../configs/.config/fish $HOME/.config/
                fi
        else
                echo "rsync command not found!"
        fi
# rsync nvim config to host manual
to-host-nvim $user:
        #!/usr/bin/env bash
        if command -v rsync &> /dev/null; then
                if [ "{{user}}" == "root" ]; then
                        sudo rsync -azP ../configs/.config/nvim /root/.config/
                else
                        rsync -azP ../configs/.config/fish $HOME/.config/
                fi
        else
                echo "rsync command not found!"
        fi
# Partitioning disk lvm on luks "/dev/sdX|vdx|nvmX"
nixos-disk-lvm-on-luks $block:
        #!/run/current-system/sw/bin/bash
        printf "\033[0;31m:: Destroy drive\n\033[0m"
        # wipe disk
        wipefs -a {{block}}
        # destroy GPT & MBR data structure
        sgdisk --zap-all {{block}}
        # EFI
        sgdisk -n 1:1m:+1G -t 1:ef00 -c 1:EFI {{block}}
        # swap partition
        # sgdisk -n 2:0:+4G -t 2:8200 -c 2:SWAP {{block}}
        # ZFS
        sgdisk -n 2:0:0 -t 2:8309 -c 2:NIXLUKS {{block}}

        printf "\033[0;33m:: Create Luks\n\033[0m"
        cryptsetup luksFormat "{{block}}2"
        printf "\033[0;32m:: Open Luks\n\033[0m"
        cryptsetup open "{{block}}2" Luks

        pvcreate /dev/mapper/Luks
        vgcreate vg_nix /dev/mapper/Luks
        # lvcreate -L 4G -n swap $vg
        # lvcreate -L 32G -n root $vg
        lvcreate -l 100%FREE -n nix_root vg_nix
        lsblk -f
        printf "\033[0;33m:: Formatting\n\033[0m"
        mkfs.fat -F32 -n EFI_BOOT"{{block}}1"
        mkfs.ext4 -L NIX /dev/vg_nix/nix_root
        printf "\033[0;33m:: Mount\n\033[0m"
        mount /dev/vg_nix/nix_root /mnt
        mount --mkdir "{{block}}1" /mnt/boot
        lsblk -f
