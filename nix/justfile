set quiet
bangbash := '#!/usr/bin/env bash'

# generate nixos config on this machine
gen:
        nixos-generate-config --root /mnt
# install nixos with flake
install $host:
        {{bangbash}}
        nixos-install --flake .#{{host}} --verbose
# rebuild nixos with flake
build $host:
        {{bangbash}}
        sudo nixos-rebuild switch --flake .#{{host}}
# flake update
flake-up:
        nix flake update

# change user
flake-user $user:
        {{bangbash}}
        sed -i 's/\(user = "\)[^"]*"/\1{{user}}"/' flake.nix
# change host
flake-host $host:
        {{bangbash}}
        sed -i 's/\(host = "\)[^"]*"/\1{{host}}"/' flake.nix
# change gui
flake-full $user:
        {{bangbash}}
        sed -i 's/.\/hosts\/base.nix/.\/hosts\/full.nix/' flake.nix
        sed -i 's/.\/modules\/base.nix/.\/modules\/full.nix/' hosts/{{user}}/default.nix
# change base
flake-base $user:
        {{bangbash}}
        sed -i 's/.\/hosts\/full.nix/.\/hosts\/base.nix/' flake.nix
        sed -i 's/.\/modules\/full.nix/.\/modules\/base.nix/' hosts/{{user}}/default.nix

# rsync fish config to host manual
to-host-fish $user:
        #!/usr/bin/env bash
        if [[ ! -d "$HOME/.config/base16-shell" ]]; then
                git clone https://github.com/chriskempson/base16-shell.git ~/.config/base16-shell
        fi
        if command -v rsync &> /dev/null; then
                if [ "{{user}}" == "root" ]; then
                        sudo rsync -azP ../configs/.config/fish /root/.config/
                else
                        rsync -azP ../configs/.config/fish $HOME/.config/
                fi
        else
                echo "rsync command not found!"
        fi
# rsync nvim config to host manual
to-host-nvim $user:
        #!/usr/bin/env bash
        if command -v rsync &> /dev/null; then
                if [ "{{user}}" == "root" ]; then
                        sudo rsync -azP ../configs/.config/nvim /root/.config/
                else
                        rsync -azP ../configs/.config/fish $HOME/.config/
                fi
        else
                echo "rsync command not found!"
        fi
# Partitioning disk lvm on luks "/dev/sdX|vdx|nvmX"
nixos-disk-lvm-on-luks $block:
        #!/usr/bin/bash
        # wipe disk
        wipefs -a {{block}}
        # destroy GPT & MBR data structure
        sgdisk --zap-all {{block}}
        # EFI
        sgdisk -n 1:1m:+1G -t 1:ef00 -c 1:EFI {{block}}
        # swap partition
        # sgdisk -n 2:0:+4G -t 2:8200 -c 2:SWAP {{block}}
        # ZFS
        sgdisk -n 2:0:0 -t 2:8309 -c 2:NIXLUKS {{block}}

        LUKSNAME=$(lsblk -f | grep crypto_LUKS | awk '{print $4}' | awk -F '-' '{print $1}')
        LUKSUUID=$(lsblk -f | grep crypto_LUKS | awk '{print $4}')
        printf "\033[0;33m:: Create Luks\n\033[0m"
        cryptsetup luksFormat "${BLOCK}2"
        cryptsetup open "{{block}}2" "Nix-Luks-${LUKSNAME}"

        pvcreate /dev/mapper/"Nix-Luks-${LUKSNAME}"
        vgcreate vg_nix /dev/mapper/"Nix-Luks-${LUKSNAME}"
        # lvcreate -L 4G -n swap $vg
        # lvcreate -L 32G -n root $vg
        lvcreate -l 100%FREE -n nix_root vg_nix
        lsblk -f


